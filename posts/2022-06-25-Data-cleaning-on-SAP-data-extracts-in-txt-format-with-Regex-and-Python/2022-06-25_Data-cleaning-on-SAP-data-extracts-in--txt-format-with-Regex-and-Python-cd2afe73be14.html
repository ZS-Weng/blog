<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Data cleaning on SAP data extracts in .txt format with Regex and Python</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Data cleaning on SAP data extracts in .txt format with Regex and Python</h1>
</header>
<section data-field="subtitle" class="p-summary">
Introduction
</section>
<section data-field="body" class="e-content">
<section name="2fe7" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a371" id="a371" class="graf graf--h3 graf--leading graf--title">Data cleaning on SAP data extracts in .txt format with Regex and Python</h3><h3 name="4c78" id="4c78" class="graf graf--h3 graf-after--h3"><strong class="markup--strong markup--h3-strong">Introduction</strong></h3><p name="0af7" id="0af7" class="graf graf--p graf-after--h3">During one of our recent projects involving the procure to pay process, our team encountered SAP raw data extracted from the system in .txt format which proved to be difficult to clean using traditional methods like readlines() or split() by delimiters due to some inherent data inconsistencies.</p><p name="5ae7" id="5ae7" class="graf graf--p graf-after--p">Regex matching proved to be helpful for such scenarios to clean the data.</p><h3 name="eddd" id="eddd" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">Common SAP tables in Procure to Pay process</strong></h3><p name="c156" id="c156" class="graf graf--p graf-after--h3">First, lets go through what are common data tables extracted from SAP as part of the Procure to Pay process.</p><ul class="postList"><li name="ff78" id="ff78" class="graf graf--li graf-after--p">Accounting Related Tables <br>- BKPF: Accounting Document Header<br>- BSAK: Accounting: Secondary Index for Vendors<br>- BSEG: Accounting Document Segment</li><li name="ede4" id="ede4" class="graf graf--li graf-after--li">Purchase Order related Tables<br>- EKKO: Purchasing Document Header<br>- EKPO: Purchasing Document Item<br>- EKBE: History per Purchasing Document<br>- EKKN: Account Assignment in Purchasing Document</li><li name="4041" id="4041" class="graf graf--li graf-after--li">Material Tables<br>- MAKT: Material Descriptions</li></ul><p name="fab7" id="fab7" class="graf graf--p graf-after--li">There are various websites which provide additional information about the SAP tables.</p><ul class="postList"><li name="4db8" id="4db8" class="graf graf--li graf-after--p"><a href="https://www.se80.co.uk/training-education/sap-tables/" data-href="https://www.se80.co.uk/training-education/sap-tables/" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://www.se80.co.uk/training-education/sap-tables/</a></li><li name="a9c6" id="a9c6" class="graf graf--li graf-after--li"><a href="https://www.tcodesearch.com/sap-tables/detail?id=BSEG" data-href="https://www.tcodesearch.com/sap-tables/detail?id=BSEG" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://www.tcodesearch.com/sap-tables/detail?id=BSEG</a> (Might need to enter through changing the id in URL without requiring premium membership)</li></ul><figure name="6833" id="6833" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*WdBn8dZI1sxJ6IBGtbQBOw.png" data-width="795" data-height="656" src="https://cdn-images-1.medium.com/max/800/1*WdBn8dZI1sxJ6IBGtbQBOw.png"><figcaption class="imageCaption">Example of Data Dictionary for BSEG Table Source: <a href="https://www.se80.co.uk/training-education/sap-tables/" data-href="https://www.se80.co.uk/training-education/sap-tables/" class="markup--anchor markup--figure-anchor" rel="nofollow noopener noopener noopener" target="_blank">https://www.se80.co.uk/</a></figcaption></figure><h3 name="9118" id="9118" class="graf graf--h3 graf-after--figure"><strong class="markup--strong markup--h3-strong">Format of SAP data extract in .txt file</strong></h3><p name="2cd1" id="2cd1" class="graf graf--p graf-after--h3">For our project, the output SAP data extracts is in a .txt format and with the typical structure as shown below:</p><ul class="postList"><li name="ec94" id="ec94" class="graf graf--li graf-after--p">The column header details starts at line 4</li><li name="c5e3" id="c5e3" class="graf graf--li graf-after--li">The width of each column is consistent between the column headers and the data for each file extracted</li><li name="9a4d" id="9a4d" class="graf graf--li graf-after--li">Actual data content starts at line 5 till the end</li></ul><figure name="4ade" id="4ade" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*J5IwUB3FoeNOfNeDufeGzA.png" data-width="1083" data-height="481" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*J5IwUB3FoeNOfNeDufeGzA.png"><figcaption class="imageCaption">Sample SAP TXT Data Extract Structure with Mock Data</figcaption></figure><p name="3a7d" id="3a7d" class="graf graf--p graf-after--figure">The sample SAP data in txt format and Jupyter Notebook can be found on GitHub: <a href="https://github.com/ZS-Weng/Data_Engineering/tree/main/Data_Cleaning" data-href="https://github.com/ZS-Weng/Data_Engineering/tree/main/Data_Cleaning" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://github.com/ZS-Weng/Data_Engineering/tree/main/Data_Cleaning</a></p><p name="3b51" id="3b51" class="graf graf--p graf-after--p">The two major data discrepancies encountered are:</p><ul class="postList"><li name="3d5f" id="3d5f" class="graf graf--li graf-after--p">Newline character inserted in some of the fields</li><li name="823a" id="823a" class="graf graf--li graf-after--li graf--trailing">Pipe (|) delimiters found within the actual data</li></ul></div></div></section><section name="0a1a" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="3d26" id="3d26" class="graf graf--h3 graf--leading">Full Code and Output</h3><p name="fa1a" id="fa1a" class="graf graf--p graf-after--h3">The full working code for the data cleaning is as shown below</p><figure name="0474" id="0474" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/ZS-Weng/9d1d9fce99d2e28f72649d7e04710307.js"></script><figcaption class="imageCaption">Python Code for Cleaning SAP Data Extract</figcaption></figure><p name="3ac6" id="3ac6" class="graf graf--p graf-after--figure">Final pandas data frame output:</p><figure name="1aba" id="1aba" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*8PAmIRBUMOmXsoOvLcxRNw.png" data-width="579" data-height="244" src="https://cdn-images-1.medium.com/max/800/1*8PAmIRBUMOmXsoOvLcxRNw.png"><figcaption class="imageCaption">Final pandas tabular output after data cleaning</figcaption></figure></div></div></section><section name="04a3" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="0711" id="0711" class="graf graf--h3 graf--leading">Detailed Walk-through of the codes</h3><h4 name="374f" id="374f" class="graf graf--h4 graf-after--h3"><strong class="markup--strong markup--h4-strong">Cleaning of newline character prior to splitting lines</strong></h4><p name="fa63" id="fa63" class="graf graf--p graf-after--h4">In order to clean the \n (newline) characters which are not valid, we first use the read() instead of readline() method as the readline() method will split the lines by the \n character automatically.</p><pre name="b39d" id="b39d" class="graf graf--pre graf-after--p">with open(&quot;Sample SAP Format.txt&quot;, encoding=&quot;utf-8&quot;) as f:        <br>    content_raw = f.read()</pre><p name="aa1f" id="aa1f" class="graf graf--p graf-after--pre">Next, we use the Regex pattern “([1|-])[\n](.)|(.)[\n]([^|-])&quot; to find and the invalid \n characters. The pattern basically detects newline that do not start with the characters “1” , “|” or “-” and do not end with the characters “|” or “-”.</p><p name="7769" id="7769" class="graf graf--p graf-after--p">For the invalid newline characters found, we replace them with a space using the .sub() method.</p><pre name="f32e" id="f32e" class="graf graf--pre graf-after--p">new_line_pattern = re.compile(&quot;([^1|-])[\n](.)|(.)[\n([^|-])&quot;)<br>content_cleaned_newline = new_line_pattern.sub(r&quot;\1 \2&quot;,content_raw)<br>content_split_line = content_cleaned_newline.split(&quot;\n&quot;)</pre><p name="e366" id="e366" class="graf graf--p graf-after--pre">Output after cleaning and splitting lines:</p><figure name="9a74" id="9a74" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*VtP-KnOL9I_PyQelgieQZw.png" data-width="709" data-height="304" src="https://cdn-images-1.medium.com/max/800/1*VtP-KnOL9I_PyQelgieQZw.png"><figcaption class="imageCaption">List of Data After the Line Split</figcaption></figure><h4 name="4029" id="4029" class="graf graf--h4 graf-after--figure">Data Cleaning Steps for Individual Line</h4><p name="c734" id="c734" class="graf graf--p graf-after--h4">Based on the above, we can see that the data we are interested in is the column header (4th line) and the rest of the data content (6th to 2nd last lines).</p><p name="a56b" id="a56b" class="graf graf--p graf-after--p">We will first split the column by the pipe “|” delimiter and getting the columns width to create the Regex matching string pattern.</p><pre name="b0ff" id="b0ff" class="graf graf--pre graf-after--p">header_string = content_split_line[3]</pre><pre name="8e8e" id="8e8e" class="graf graf--pre graf-after--pre">column_header = [token.strip() for token in header_string.split(&quot;|&quot;)][1:-1]</pre><pre name="a12d" id="a12d" class="graf graf--pre graf-after--pre">list_column_width = [&quot;(.{&quot; + str(len(column)) + &quot;})&quot; for column in header_string.split(&quot;|&quot;)][1:-1]</pre><pre name="64d4" id="64d4" class="graf graf--pre graf-after--pre">column_string_pattern = &quot;[|]&quot; + &quot;[|]&quot;.join(list_column_width) + &quot;[|]&quot;</pre><p name="3cd4" id="3cd4" class="graf graf--p graf-after--pre">The column_string_pattern to match that is generated for the sample data will be as follows:</p><blockquote name="d51f" id="d51f" class="graf graf--blockquote graf--startsWithDoubleQuote graf-after--p">“[|](.{10})[|](.{4})[|](.{3})[|](.{10})[|](.{20})[|]”</blockquote><p name="0e79" id="0e79" class="graf graf--p graf-after--blockquote">This column pattern matching pattern is dynamically generated and will be unique for each of the data extract file even for the same tables as the width is adjusted during data extract according to the content.</p><p name="5823" id="5823" class="graf graf--p graf-after--p">We will then use the matching pattern to extract the rest of the data (6th to 2nd last line) with re.match().groups() instead of using the str.split() method.</p><pre name="4c84" id="4c84" class="graf graf--pre graf-after--p">column_pattern = re.compile(column_string_pattern)</pre><pre name="622e" id="622e" class="graf graf--pre graf-after--pre">cleaned_content = [[token.strip() for token in column_pattern.match(row).groups()] for row in content_split_line[5:-2]]</pre><p name="ac82" id="ac82" class="graf graf--p graf-after--pre">The output after content splitting:</p><figure name="0603" id="0603" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*HFCDy2xsSt3uh6kBlkLLlg.png" data-width="688" data-height="125" src="https://cdn-images-1.medium.com/max/800/1*HFCDy2xsSt3uh6kBlkLLlg.png"><figcaption class="imageCaption">Data in Nested List format after splitting of content of each individual line</figcaption></figure><p name="2794" id="2794" class="graf graf--p graf-after--figure">Here we can see that the extra delimiters e.g. ‘Item A|B|C’ does not affect the content splitting .</p><p name="ce76" id="ce76" class="graf graf--p graf-after--p">Finally, we combine the cleaned header columns and data into a pandas data frame.</p><pre name="7211" id="7211" class="graf graf--pre graf-after--p">df_clean = pd.DataFrame(cleaned_content, columns=column_header)</pre><p name="5c1a" id="5c1a" class="graf graf--p graf-after--pre">Final pandas Data Frame output:</p><figure name="fe75" id="fe75" class="graf graf--figure graf-after--p graf--trailing"><img class="graf-image" data-image-id="1*mXFwk_UZYDW1f4dgEICkpQ.png" data-width="574" data-height="238" src="https://cdn-images-1.medium.com/max/800/1*mXFwk_UZYDW1f4dgEICkpQ.png"><figcaption class="imageCaption">Final cleaned data output in pandas Data Frame</figcaption></figure></div></div></section><section name="8cfb" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="2fd0" id="2fd0" class="graf graf--h3 graf--leading">Useful Learning Resource for Python and Regex</h3><p name="e759" id="e759" class="graf graf--p graf-after--h3">When I was starting out, I found the book <em class="markup--em markup--p-em">Automate the Boring Stuff with Python by Al Sweigart</em> one of the best resources to learning about Python and Regex with many practical examples.</p><p name="4175" id="4175" class="graf graf--p graf-after--p graf--trailing">There is a free access option to the book on his website: <a href="https://automatetheboringstuff.com/" data-href="https://automatetheboringstuff.com/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://automatetheboringstuff.com/</a> and this is the link to the specific chapter on Regex which formed the foundation on some of the implementation: <a href="https://automatetheboringstuff.com/2e/chapter7/" data-href="https://automatetheboringstuff.com/2e/chapter7/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://automatetheboringstuff.com/2e/chapter7/</a></p></div></div></section><section name="69c1" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="f65f" id="f65f" class="graf graf--p graf--leading">Thanks for reading and hope the information was useful in some way!</p><p name="56bd" id="56bd" class="graf graf--p graf-after--p">Zaishan is the Data Analytics and AI Lead at IBM focusing on leading digital transformation, data analytics and business process re-engineering initiatives across multiple industries.</p><p name="ef5e" id="ef5e" class="graf graf--p graf-after--p graf--trailing">He is passionate about leveraging technology to make a difference, simplify the complex and optimize the mundane with the hope that we can have more time and energy to pursue our interests and dreams.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@zaishanweng" class="p-author h-card">Zaishan Weng</a> on <a href="https://medium.com/p/cd2afe73be14"><time class="dt-published" datetime="2022-06-25T13:08:06.506Z">June 25, 2022</time></a>.</p><p><a href="https://medium.com/@zaishanweng/data-cleaning-on-sap-data-extracts-with-regex-and-python-cd2afe73be14" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 5, 2023.</p></footer></article></body></html>